#!/usr/bin/env ruby
# frozen_string_literal: true

# This script can be used to pull objects from preservation, if we need to re-accession it into DOR.
#
# You must run it from ~/preservation_catalog/current/
# using:
#
# bin/create_bag /directory/with/druids/druid-list.txt /some/directory
#
# where /directory/with/druids/druid-list.txt is wherever your druid file list is,
# and where /some/directory is wherever you want the bags to land, usually in the tmp directory.
#
# NOTE: druids should be each on their own line in the list, with or without the druid prefix,
# e.g. druid:pv564yb1711 or pv564yb1711

# Set default environment if not already set by the command line
ENV["RAILS_ENV"] ||= "production"

require_relative '../config/environment'

File.foreach(ARGV[0], chomp: true).each do |druid|
  bare_druid = druid.delete_prefix('druid:')
  storage_object = Stanford::StorageServices.find_storage_object(bare_druid)
  version_id = storage_object.current_version_id
  bag_dir = "#{ARGV[1]}/bags/#{bare_druid}"
  storage_object.reconstruct_version(version_id, bag_dir)
rescue Moab::ObjectNotFoundException => e
  puts "#{bare_druid}, #{e}"
end
